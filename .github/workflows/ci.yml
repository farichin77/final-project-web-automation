name: Web B2B Dibimbing.id Automation CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, edge, firefox]

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: 'gradle'

      - name: Install browsers (NO SNAP)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

          # 1. Setup Firefox via Mozilla PPA
          sudo add-apt-repository -y ppa:mozillateam/ppa
          echo '
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001
          ' | sudo tee /etc/apt/preferences.d/mozilla-firefox
          sudo apt-get update
          sudo apt-get install -y firefox

          # 2. Install Chrome
          sudo apt-get install -y google-chrome-stable

          # 3. Install Edge Browser
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /usr/share/keyrings/microsoft.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main" | sudo tee /etc/apt/sources.list.d/microsoft-edge.list
          sudo apt-get update
          sudo apt-get install -y microsoft-edge-stable

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Tests (${{ matrix.browser }})
        continue-on-error: true
        # Clean build before running to ensure no stale results
        run: |
          xvfb-run ./gradlew clean test --tests "tests.**" -Dbrowser=${{ matrix.browser }}
          
          # Prepare results for upload
          mkdir -p build/test-results/${{ matrix.browser }}
          
          # Copy XML results if they exist
          if [ -d "build/test-results/test" ]; then
            cp -r build/test-results/test/. build/test-results/${{ matrix.browser }}/ 2>/dev/null || cp -r build/test-results/test/* build/test-results/${{ matrix.browser }}/ || true
            echo "Copied ${{ matrix.browser }} test results"
          else
            echo "No test results found for ${{ matrix.browser }}"
          fi
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          LOGIN_EMAIL: ${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}

      - name: Upload Test Results (${{ matrix.browser }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: build/test-results/${{ matrix.browser }}
          retention-days: 1

  notify:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download All Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: all-results
          merge-multiple: false

      - name: Consolidate Results and Notify Slack
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os
          import json
          import time
          import urllib.request
          
          # Configuration
          results_base_dir = 'all-results'
          browsers = ['chrome', 'edge', 'firefox']
          webhook_url = "${{ secrets.SLACK_WEBHOOK_URL }}"
          
          browser_stats = {}
          
          def parse_testng_xml(xml_path):
              stats = {'total': 0, 'passed': 0, 'failed': 0, 'skipped': 0}
              try:
                  tree = ET.parse(xml_path)
                  root = tree.getroot()
                  
                  testsuites = []
                  if root.tag == 'testsuite':
                      testsuites = [root]
                  else:
                      testsuites = root.findall('.//testsuite')
                  
                  for testsuite in testsuites:
                      testcases = testsuite.findall('.//testcase')
                      if testcases:
                          for testcase in testcases:
                              stats['total'] += 1
                              if testcase.find('failure') is not None or testcase.find('error') is not None:
                                  stats['failed'] += 1
                              elif testcase.find('skipped') is not None:
                                  stats['skipped'] += 1
                              else:
                                  stats['passed'] += 1
                      else:
                          # Fallback to attributes if no testcase elements
                          stats['total'] += int(testsuite.attrib.get('tests', 0))
                          stats['failed'] += int(testsuite.attrib.get('failures', 0))
                          stats['skipped'] += int(testsuite.attrib.get('skipped', 0))
                          stats['passed'] = stats['total'] - stats['failed'] - stats['skipped']
                          
              except Exception as e:
                  print(f"Error parsing {xml_path}: {e}")
              return stats
          
          print("Scanning for test results...")
          
          for browser in browsers:
              # Artifacts are downloaded into subdirectories named 'test-results-{browser}'
              browser_path = os.path.join(results_base_dir, f'test-results-{browser}')
              
              stats = {'total': 0, 'passed': 0, 'failed': 0, 'skipped': 0, 'emoji': ''}
              
              # Set emoji
              if browser == 'chrome': stats['emoji'] = "üîµ"
              elif browser == 'edge': stats['emoji'] = "üü¢"
              elif browser == 'firefox': stats['emoji'] = "üü†"
              
              if os.path.exists(browser_path):
                  xml_files = []
                  for root, dirs, files in os.walk(browser_path):
                      for file in files:
                          if file.endswith('.xml'):
                              xml_files.append(os.path.join(root, file))
                  
                  print(f"Found {len(xml_files)} XML files for {browser}")
                  
                  for xml_file in xml_files:
                      file_stats = parse_testng_xml(xml_file)
                      stats['total'] += file_stats['total']
                      stats['passed'] += file_stats['passed']
                      stats['failed'] += file_stats['failed']
                      stats['skipped'] += file_stats['skipped']
                  
                  if stats['total'] > 0:
                      browser_stats[browser] = stats
              else:
                  print(f"Directory not found for {browser}: {browser_path}")
          
          # Prepare Slack Notification
          if not webhook_url:
              print("SLACK_WEBHOOK_URL is not set.")
              exit(0)
              
          if not browser_stats:
              print("No test results found to report.")
              # Optional: Send a failure notification stating no results found
              exit(0)
              
          # Calculate Grand Totals
          total_all = sum(s['total'] for s in browser_stats.values())
          passed_all = sum(s['passed'] for s in browser_stats.values())
          failed_all = sum(s['failed'] for s in browser_stats.values())
          skipped_all = sum(s['skipped'] for s in browser_stats.values())
          
          if failed_all > 0:
              summary_color = "danger"
              summary_title = "üö® Automation Failed"
          elif total_all == 0:
              summary_color = "warning"
              summary_title = "‚ö†Ô∏è No Tests Run"
          else:
              summary_color = "good"
              summary_title = "‚úÖ Automation Passed"
              
          # Build Fields for each browser
          fields = []
          for browser, stats in browser_stats.items():
              browser_name = browser.capitalize()
              status_icon = "‚ùå" if stats['failed'] > 0 else "‚úÖ"
              if stats['total'] == 0: status_icon = "‚ö†Ô∏è"
              
              value_text = f"Total: {stats['total']} | Pass: {stats['passed']} | Fail: {stats['failed']}"
              fields.append({
                  "title": f"{stats['emoji']} {browser_name} {status_icon}",
                  "value": value_text,
                  "short": False
              })
              
          # Add Overall Summary field
          fields.append({
              "title": "üìä Overall Summary",
              "value": f"*Total:* {total_all}\n*Passed:* {passed_all}\n*Failed:* {failed_all}\n*Skipped:* {skipped_all}",
              "short": False
          })
          
          payload = {
              "attachments": [{
                  "color": summary_color,
                  "pretext": f"*{summary_title} - Web B2B Dibimbing.id*",
                  "fields": fields,
                  "footer": "GitHub Actions - Parallel Execution Matrix",
                  "ts": int(time.time())
              }]
          }
          
          try:
              data = json.dumps(payload).encode('utf-8')
              req = urllib.request.Request(webhook_url, data=data, headers={'Content-Type': 'application/json'})
              with urllib.request.urlopen(req) as response:
                  print(f"Notification sent! Status: {response.status}")
          except Exception as e:
              print(f"Failed to send notification: {e}")
          EOF